<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Inference</title>
    <link rel="icon" href="https://www.sambanova.ai/favicon.ico" type="image/ico">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/default.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>

<div class="container mt-5">
    <h1 class="text-center">Cloud Inference Demo</h1>

    <!-- Service Selection Dropdown -->
    <form id="inference-form" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label for="services">Select Inference Services to Compare:</label>
            <select class="form-control selectpicker" id="services" name="services" multiple="multiple" required></select>
        </div>

        <div class="form-group">
            <label for="prompt">Enter your prompt:</label>
            <textarea class="form-control" id="prompt" name="prompt" rows="3" required></textarea>
        </div>
        
        <div class="form-group" style="display:none">
            <label for="streaming">Enable Streaming:</label>
            <input type="checkbox" id="streaming" name="streaming" value="true" />
        </div>
        
        <div class="form-group">
            <label for="file">Upload Image or Audio (optional):</label>
            <div class="file-selection">
                <input type="file" class="form-control-file col-md-6" id="fileInput" name="file" accept="image/*,audio/*" style="display: block; margin-bottom: 10px;" />
            </div>
        </div>

        <button type="submit" class="btn btn-submit">Submit</button>
    </form>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading mt-1 mb-1" style="display:none;">
        <span>.</span><span>.</span><span>.</span>
    </div>

    <!-- Results Section -->
    <div id="results" class="row mt-5 mb-5"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.5/dist/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>

<script>
    const servicesList = [
        { name: 'openai', logo: 'https://www.openai.com/favicon.ico', displayName: 'OpenAI' },
        { name: 'groq', logo: 'https://groq.com/wp-content/uploads/2024/02/android-icon-192x192-1.png', displayName: 'GroQ' },
        { name: 'sambanova', logo: 'https://www.sambanova.ai/favicon.ico', displayName: 'SambaNova' },
        { name: 'together', logo: 'https://cdn.prod.website-files.com/64f6f2c0e3f4c5a91c1e823a/654693d90fe837461728588f_webclip.png', displayName: 'Together' },
        { name: 'cerebras', logo: 'https://cerebras.ai/wp-content/uploads/2022/05/cropped-cerebras-logo-fav-32x32.png', displayName: 'Cerebras' },
    ];

    // Get URL parameters for services and prompt
    const urlParams = new URLSearchParams(window.location.search);
    const servicesFromUrl = urlParams.get('services') ? urlParams.get('services').split(',') : [];
    const promptFromUrl = urlParams.get('prompt') || '';
    const isStreaming = urlParams.get('streaming') === 'true';

    // Populate the dropdown and select services from URL parameters
    const servicesSelect = document.getElementById('services');
    servicesList.forEach(service => {
        const option = document.createElement('option');
        option.value = service.name;
        option.textContent = service.displayName;
        servicesSelect.appendChild(option);
    });

    // Pre-select services from the URL
    servicesFromUrl.forEach(service => {
        const option = servicesSelect.querySelector(`option[value="${service}"]`);
        if (option) {
            option.selected = true;
        }
    });

    // Refresh the Bootstrap select picker
    $('#services').selectpicker('refresh');

    // Set the prompt if passed in the URL
    document.getElementById('prompt').value = promptFromUrl;
    const streamingCheckbox = document.getElementById('streaming');
    streamingCheckbox.checked = isStreaming;

    document.addEventListener("DOMContentLoaded", function () {

        document.getElementById('inference-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Get selected services
            const selectedServices = Array.from(document.getElementById('services').selectedOptions).map(option => option.value);
            const uniqueServices = [...new Set(selectedServices)];
            const prompt = document.getElementById('prompt').value;
            const isStreaming = document.getElementById('streaming').checked;

            // Update URL with selected services and prompt
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('services', uniqueServices.join(','));
            newUrl.searchParams.set('prompt', prompt);
            newUrl.searchParams.set('streaming', isStreaming);
            history.pushState({}, '', newUrl);

            // Show loading indicator
            document.getElementById('loading-indicator').style.display = 'block';

            const formData = new FormData(this);

            // Add streaming option if checked
            formData.append('streaming', isStreaming);

            // Append selected services to form data
            uniqueServices.forEach(service => {
                formData.append('services', service);
            });

            // Handle file upload and convert to Base64
            const fileInput = document.getElementById('fileInput');
            if (fileInput && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onloadend = function() {
                    const base64File = reader.result.split(',')[1]; // Get Base64 string
                    const fileExtension = file.name.split('.').pop().toLowerCase(); // Extract file extension
                    const fileType = file.type.startsWith('image/') ? 'image' : file.type.startsWith('audio/') ? 'audio' : 'unknown';
                    
                    formData.append('fileBase64', base64File);
                    formData.append('fileType', fileType);
                    formData.append('fileExtension', fileExtension);
                    formData.append('fileName', file.name);
                    submitFormData(formData);
                };
                reader.readAsDataURL(fileInput.files[0]); 
            } else {
                submitFormData(formData);
            }

            async function submitFormData(formData) {
                response = await fetch('/infer', {
                        method: 'POST',
                        body: formData
                });
                if (response.ok) {
                    const data = await response.json();
                    showResults(data);
                } else {
                    console.error(response.statusText);
                }
            }

            function showResults(results) {
                console.log('results', results);
                // Hide loading indicator
                document.getElementById('loading-indicator').style.display = 'none';

                // Clear previous results
                document.getElementById('results').innerHTML = '';

                // Create a container div for the results
                const rowDiv = document.createElement('div');
                rowDiv.classList.add('d-flex', 'flex-wrap', 'justify-content-start');

                // Calculate column size based on number of services selected
                const totalServices = uniqueServices.length;
                let colSize = 4;  // Default for 3 services

                if (totalServices === 2) {
                    colSize = 6; 
                } else if (totalServices === 1) {
                    colSize = 12;
                } 

                // For Flexbox grid (auto adjust)
                uniqueServices.forEach(service => {
                    const result = results[service];

                    // Create a new column for each service
                    const resultColumn = document.createElement('div');
                    resultColumn.classList.add(`col-md-${colSize}`, 'result-column', 'mt-2', 'mb-2');

                    // Create the logo element
                    const logo = document.createElement('img');
                    logo.src = servicesList.find(s => s.name === service).logo;
                    logo.classList.add('inference-logo');
                    logo.alt = `${service} Logo`;

                    // Create the title (h4)
                    const title = document.createElement('h4');
                    title.classList.add('text-center');
                    title.textContent = servicesList.find(s => s.name === service).displayName;

                    // Create tokens info
                    const tokensInfo = document.createElement('div');
                    tokensInfo.classList.add('tokens-info');

                    // Time and tokens sections
                    const timeTokens = document.createElement('div');
                    timeTokens.classList.add('time-tokens');
                    timeTokens.innerHTML = `
                        <div><span class="label">Time</span> <span class="value">${(result.timeTaken).toFixed(2)}s</span></div>
                        <div><span class="label">Tokens</span> <span class="value">${result.totalTokens} (input: ${result.inputTokens}, output: ${result.outputTokens})</span></div>
                    `;
                    tokensInfo.appendChild(timeTokens);

                    // Model section
                    const modelSection = document.createElement('div');
                    modelSection.classList.add('model');
                    modelSection.innerHTML = `
                        <span class="label">Model</span> <span class="value">${result.model}</span>
                    `;
                    tokensInfo.appendChild(modelSection);

                    // Pre and code elements for result (normal or error)
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    code.id = `result-${service}-text`;
                    code.classList.add('result-box');

                    if (result.error !== undefined) {
                        code.textContent = result.error;
                    } else { 
                        const markdownContent = marked.parse(result.result);
                        const sanitizedContent = DOMPurify.sanitize(markdownContent);
                        code.innerHTML = sanitizedContent;
                    }

                    // Append pre/code to result column
                    pre.appendChild(code);

                    // Append all parts to the result column
                    resultColumn.appendChild(logo);
                    resultColumn.appendChild(title);
                    resultColumn.appendChild(tokensInfo);
                    resultColumn.appendChild(pre);

                    // Append the result column to the row
                    rowDiv.appendChild(resultColumn);

                    hljs.highlightElement(code);
                });

                // Append the results row to the main results container
                document.getElementById('results').appendChild(rowDiv);
            }
        });
    });

</script>

</body>
</html>
